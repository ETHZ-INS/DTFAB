---
title: "Paper title"
subtitle: "Supplementary Figures"
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: Pierre-Luc Germain
output:
  pdf_document:
    fig_width: 8
    fig_height: 6
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE)
FIG_NB <- 0
FIG_STRING <- "Supplementary Figure "
getFigNb <- function(increment=FALSE){
  if(increment) FIG_NB <<- FIG_NB + 1
  paste0(FIG_STRING,FIG_NB)
}
```

```{r}
suppressPackageStartupMessages({
  library(ggplot2)
  library(cowplot)
})
```

# `r getFigNb(TRUE)`

```{r DAvolcanos}
das2 <- readRDS("../misc/allDAres.rds")
nsig <- dplyr::bind_rows(lapply(split(das2, das2$Dataset), FUN=function(x){
  data.frame(n=nrow(x), sig=sum(x$FDR<0.05,na.rm=TRUE),
             unadj=sum(x$PValue<0.05,na.rm=TRUE),
             unadjProp=sum(x$PValue<0.05,na.rm=TRUE)/nrow(x))
}), .id="Dataset + ylim(c(-0.3,5))")
nsig$label <- paste0("q<0.05: ", nsig$sig, "\np<0.05: ", round(100*nsig$unadjProp), "%")
p1 <- ggplot(das2, aes(logFC, -log10(FDR))) + geom_hline(yintercept = -log10(0.05), linetype="dashed", colour="grey") + theme_bw() +
  ggrastr::geom_point_rast(size=0.5) + facet_wrap(~Dataset) + 
  geom_text(data=nsig, x=-4, y=max(sqrt(-log10(das2$FDR))), vjust=1, aes(label=label), size=3) + scale_y_sqrt()
```

```{r }
peakr <- readRDS("../misc/motifPeakData.rds")
```

```{r, fig.width=9, fig.height=3}
p2 <- cowplot::plot_grid(
  ggplot(peakr, aes(Dataset, atacPeakLog2EnrichmentWithinMotifs, fill=Motif, label=Motif, Group=Motif)) + 
  geom_col(position="dodge") + geom_text(position = position_dodge(width = .9), angle=90, hjust=0, size=3) + 
  ylab("log2(enrichment) of ChIP peaks\nin motif-containing ATAC peaks") + ylim(c(-0.3,5)) +
  theme_bw() + theme(legend.position = "none", axis.text.x=element_text(angle=45, hjust=1, vjust=1)),
  ggplot(peakr, aes(Dataset, ChIPpeaksWithMotif, fill=Motif, label=Motif, Group=Motif)) + 
  geom_col(position="dodge") + geom_text(position = position_dodge(width = .9), angle=90, hjust=0, size=3) + 
  ylab("Proportion of ChIP peaks\ncontaining the motif") + ylim(0,0.5) +
  theme_bw() + theme(legend.position = "none", axis.text.x=element_text(angle=45, hjust=1, vjust=1)),
  nrow=1, labels=LETTERS[2:3], scale=0.95)
#p2
```

```{r, fig.height=10, fig.width=9}
cowplot::plot_grid(
  p1, p2, nrow=2, rel_heights=c(2,1), labels=c("A",NA), scale=c(0.95,1)
)
```

## `r getFigNb()`

**Overview of the benchmark datasets and TFs. A:** Volcano plot of the differential accessibility analysis, illustrating the extent and significance of changes upon treatment in each dataset. The dashed line represents a 0.05 FDR threshold, and indicated are the number of ATAC peaks passing this threshold, as well as the proportion of peaks with an uncorrected p-value lower than 0.05. **B:** Enrichment for experimental binding sites of the factor (main TF after which the datasets are named) in ATAC peaks containing the respective motifs, versus all ATAC peaks. **C:** Proportion of ChIPseq peaks (overlapping ATAC peaks) that contain the respective motifs.



